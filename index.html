<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NotaTerjun PWA</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1d4ed8">
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: Arial, sans-serif; background:#f4f4f8; margin:0; padding:20px; }
.container { max-width:900px; margin:auto; display:flex; gap:20px; flex-wrap:wrap; }
.left, .right { flex:1; background:white; padding:15px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
h1 { font-size:2rem; font-weight:bold; text-align:center; margin-bottom:10px; color:#1d4ed8; }
.notice { background:#fff3cd; padding:12px; border-radius:10px; margin-bottom:20px; text-align:center; font-style:italic; color:#856404; }
.group, .subgroup { margin-bottom:10px; padding:6px 4px; border-bottom:1px solid #e5e7eb; }
.group-title, .subgroup-title { font-weight:bold; margin-bottom:4px; }
textarea { width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:8px; margin-bottom:6px; resize:vertical; min-height:360px; background:white; font-size:14px; line-height:1.4; }
button { padding:6px 12px; margin:4px 2px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; color:white; transition:0.2s; }
button.addGroup { background:#1d4ed8; }
button.addSubgroup { background:#f59e0b; }
button.save { background:#10b981; }
button.export { background:#2563eb; }
button.import { background:#f43f5e; }
#message { padding:10px; margin-top:10px; display:none; border-radius:8px; text-align:center; font-weight:bold; }
#message.error { background:#fee2e2; color:#b91c1c; }
#message.success { background:#d1fae5; color:#065f46; }
</style>
</head>
<body>
<div class="container">
<div class="left">
<h1>NotaTerjun</h1>

<div class="notice">
Nota: App ini adalah second brain untuk menangkap idea spontan. Anda boleh tambah kumpulan, subkumpulan, dan nota. App ini adalah tempat idea sementara; selepas beberapa waktu luang atau waktu kerajinan Sayaz tiba, Sayaz akan memasukkannya ke dalam Dokumen Utama iaitu "Wan Law".<br>
Anda juga boleh sunting kumpulan, subkumpulan, dan nota mengikut kehendak sendiri.
</div>

<div id="groupsContainer"></div>

<button class="addGroup" id="addGroupBtn">Tambah Kumpulan</button>

<div class="notice" style="margin-top:10px;">
Nota: App ini adalah second brain untuk menangkap idea spontan. Anda boleh tambah kumpulan, subkumpulan, dan nota. App ini adalah tempat idea sementara; selepas beberapa waktu luang atau waktu kerajinan Sayaz tiba, Sayaz akan memasukkannya ke dalam Dokumen Utama iaitu "Wan Law".<br>
Anda juga boleh sunting kumpulan, subkumpulan, dan nota mengikut kehendak sendiri.
</div>
</div>

<div class="right">
<h1>Nota</h1>
<textarea id="noteArea" placeholder="Tulis idea spontan di sini..." rows="18"></textarea>
<div>
<button class="save" id="saveNote">Simpan Nota</button>
<button class="export" id="exportJSON">Export JSON</button>
<button class="import" id="importJSON">Import JSON</button>
<input type="file" id="importFile" accept=".json" style="display:none;">
</div>
<div id="message"></div>
</div>
</div>

<script>
// IndexedDB untuk simpan nota besar
let db;
const request = indexedDB.open("NotaTerjunDB",1);
request.onupgradeneeded = function(e){ db = e.target.result; if(!db.objectStoreNames.contains('notes')) db.createObjectStore('notes',{keyPath:'id'}); };
request.onsuccess = function(e){ db = e.target.result; loadAllNotes(); };
request.onerror = function(e){ console.error('DB error', e); showMessage('Gagal buka DB',true); };

// State
let groups = {
  "Pelajaran": ["Tips", "Presentation"],
  "Sosial": ["Kajian", "Pengalaman & Kesedaran"]
};
let notes = {}; // { "Pelajaran/Tips": "nota..." }
let currentSelection = null;

function showMessage(msg,error=false){ const m=document.getElementById('message'); m.textContent=msg; m.className=error?'error':'success'; m.style.display='block'; setTimeout(()=> m.style.display='none',1200); }

// IndexedDB helpers
function saveNoteDB(id, content){
 const tx = db.transaction('notes','readwrite'); const store = tx.objectStore('notes');
 store.put({id,content});
}
function loadNoteDB(id, callback){
 const tx = db.transaction('notes','readonly'); const store = tx.objectStore('notes');
 const req = store.get(id);
 req.onsuccess = ()=> callback(req.result?req.result.content:'');
}

// Load all notes into local state
function loadAllNotes(){
 const tx = db.transaction('notes','readonly'); const store = tx.objectStore('notes');
 const req = store.getAll();
 req.onsuccess = ()=>{ req.result.forEach(r=>notes[r.id]=r.content); renderGroups(); };
}

// Render
function renderGroups(){
 const container = document.getElementById('groupsContainer');
 container.innerHTML='';

 Object.keys(groups).forEach(g=>{
  const gDiv = document.createElement('div'); gDiv.className='group';
  const gTitle = document.createElement('div'); gTitle.className='group-title'; gTitle.textContent=g;
  gDiv.appendChild(gTitle);

  const addSubBtn = document.createElement('button');
  addSubBtn.textContent = 'Tambah SubKumpulan';
  addSubBtn.className = 'addSubgroup';
  addSubBtn.addEventListener('click',()=>{
    const name = prompt('Nama sub-kumpulan baru:'); if(!name) return;
    groups[g].push(name); renderGroups();
  });
  gDiv.appendChild(addSubBtn);

  groups[g].forEach(sg=>{
    const sgDiv = document.createElement('div'); sgDiv.className='subgroup';
    const sgTitle = document.createElement('div'); sgTitle.className='subgroup-title'; sgTitle.textContent=sg;
    sgDiv.appendChild(sgTitle);

    const selectBtn = document.createElement('button'); 
    selectBtn.textContent='Pilih SubKumpulan';
    selectBtn.addEventListener('click',()=>{
      currentSelection = g+'/'+sg;
      document.getElementById('noteArea').value = notes[currentSelection]||'';
      showMessage(`SubKumpulan ${currentSelection} dipilih`);
    });
    sgDiv.appendChild(selectBtn);
    gDiv.appendChild(sgDiv);
  });

  container.appendChild(gDiv);
 });
}

// Add group
document.getElementById('addGroupBtn').addEventListener('click',()=>{
 const name = prompt('Nama kumpulan baru:'); if(!name) return; groups[name]=[]; renderGroups();
});

// Save note
document.getElementById('saveNote').addEventListener('click',()=>{
 if(!currentSelection){ showMessage('Pilih SubKumpulan dahulu',true); return; }
 const content = document.getElementById('noteArea').value; notes[currentSelection]=content;
 saveNoteDB(currentSelection, content);
 showMessage('Nota disimpan');
});

// Export/Import JSON
document.getElementById('exportJSON').addEventListener('click',()=>{
 const blob = new Blob([JSON.stringify({groups,notes},null,2)],{type:'application/json'});
 const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='notaTerjun.json'; a.click();
});
document.getElementById('importJSON').addEventListener('click',()=>{ document.getElementById('importFile').click(); });
document.getElementById('importFile').addEventListener('change',e=>{
 const file = e.target.files[0]; if(!file) return;
 const reader = new FileReader();
 reader.onload = function(evt){
   try{
     const data = JSON.parse(evt.target.result);
     groups = data.groups||groups;
     notes = data.notes||notes;
     // Save all notes to DB
     Object.keys(notes).forEach(id=>saveNoteDB(id, notes[id]));
     renderGroups();
     showMessage('Data berjaya diimport');
   }catch(err){ showMessage('Import gagal',true); console.error(err); }
 };
 reader.readAsText(file);
 e.target.value='';
});

// Init
window.addEventListener('DOMContentLoaded',()=>{ renderGroups(); });
</script>

<script>
// Register Service Worker untuk PWA
if('serviceWorker' in navigator){
 navigator.serviceWorker.register('sw.js').then(()=>console.log('Service Worker registered')).catch(console.error);
}
</script>
</body>
</html>
